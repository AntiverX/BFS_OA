{% extends "base.html" %}

{% block content %}
    <script>
        $(document).ready(function () {
            /* 禁用修改和删除按钮 */
            $("#deleteForm").attr("disabled", true);
            $("#modify").attr("disabled", true);
            /* 删除按钮相关功能实现 */
            $("#deleteForm").click(function () {
                var button_action = $("<input type='text' name='btn' value='delete' hidden>")
                $("#planForm").append(button_action);
                $("#planForm").submit();
            });
            /* 点击某一行启用修改和删除按钮并增加选中效果 */
            $("tbody tr").click(function () {
                $("#target_id").val(this.title);
                $("#deleteForm").attr("disabled", false);
                $("#modify").attr("disabled", false);
                if ($("tr").hasClass("table-active")) {
                    $("tr").removeClass("table-active");
                }
                $(this).addClass("table-active");
            });
            /* 点击某一行自动填充表单，与数据库结构有关，不可直接复制 */
            $("tr").click(function () {
                $("#plan_name").val($(this).children("td").eq(1).text());
                $("#plan_result").val($(this).children("td").eq(2).text());
                $("#type").val($(this).children("td").eq(0).text());
                if ($(this).children("td").eq(3).text() == "是") {
                    $("#is_reviewed").val(1).change();
                }
                else {
                    $("#is_reviewed").val(0).change();
                }
                $("#head_person").val($(this).children("td").eq(4).text());
                $("#affiliated_person").val($(this).children("td").eq(5).text());
                $("#planed_time").val($(this).children("td").eq(6).text());
                $("#planed_start_time").val($(this).children("td").eq(7).text());
                $("#planed_end_time").val($(this).children("td").eq(8).text());
                $("#actual_time").val($(this).children("td").eq(9).text());
                $("#actual_start_time").val($(this).children("td").eq(10).text());
                $("#actual_end_time").val($(this).children("td").eq(11).text());
                $("#advanced_postponed_time").val($(this).children("td").eq(12).text());
                $("#remark").val($(this).children("td").eq(13).text());
                $("#target_id").val(this.title);
            });

            $("#planed_start_time").change(function () {
                text = $("#planed_start_time").val();
                csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
                $.post('/topic_manager/valid', {
                    planed_start_time: text,
                    csrfmiddlewaretoken: csrftoken
                }, function (result) {
                    if (result == "OK") {
                        $("#planed_start_time").removeClass("is-invalid");
                        $("#planed_start_time").addClass("is-valid");
                        if (!$("input").hasClass("is-invalid")) {
                            $("submitForm").attr("disabled", false);
                        }
                    }
                    else {
                        $("#planed_start_time-invalid").text(result);
                        $("#planed_start_time").removeClass("is-valid");
                        $("#planed_start_time").addClass("is-invalid");
                        $("submitForm").attr("disabled", true);
                    }
                });
            });

            $("#planed_end_time").change(function () {
                text = $("#planed_end_time").val();
                csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
                $.post('/topic_manager/valid', {
                    planed_end_time: text,
                    csrfmiddlewaretoken: csrftoken
                }, function (result) {
                    if (result == "OK") {
                        $("#planed_end_time").removeClass("is-invalid");
                        $("#planed_end_time").addClass("is-valid");
                        if (!$("input").hasClass("is-invalid")) {
                            $("submitForm").attr("disabled", false);
                        }
                    }
                    else {
                        $("#planed_end_time-invalid").text(result);
                        $("#planed_end_time").removeClass("is-valid");
                        $("#planed_end_time").addClass("is-invalid");
                        $("submitForm").attr("disabled", true);
                    }
                });
            });
        });
    </script>
    <style>
        .modal-dialog.modal-800 {
            width: 1100px;
            max-width: 1100px;
        }
    </style>
    <div class="container-fluid">
        <!-- Button trigger modal -->
        <div class="mt-3">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter">添加</button>
            <button type="button" class="btn btn-primary ml-4" data-toggle="modal" data-target="#exampleModalCenter" id="modify">修改</button>
            <button type="button" class="btn btn-primary ml-4" id="deleteForm">删除</button>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-800 modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalCenterTitle">目标</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" id="planForm">
                            <input type="hidden" id="target_id" name="target_id" value="">
                            {% csrf_token %}
                            <div class="">
                                <div class="form-group">
                                    <label for="plan_name">任务名称</label>
                                    <input type="text" class="form-control" id="plan_name" name="plan_name" required>
                                </div>
                                <div class="form-group">
                                    <label for="plan_result">工作成果</label>
                                    <input type="text" class="form-control" id="plan_result" name="plan_result" required>
                                </div>
                                <div class="row">
                                    <div class="form-group col-2">
                                        <label for="type">任务类型</label>
                                        <input type="text" class="form-control" id="type" name="type" required>
                                    </div>

                                    <div class="form-group col-2">
                                        <label for="is_reviewed">是否通过评审</label>
                                        <select class="custom-select" id="is_reviewed" name="is_reviewed" required>
                                            <option value="1" selected>是</option>
                                            <option value="0">否</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-2">
                                        <label for="head_person">负责人</label>
                                        <input type="text" class="form-control" id="head_person" name="head_person" required>
                                    </div>

                                    <div class="form-group col-6">
                                        <label for="affiliated_person">参与人</label>
                                        <input type="text" class="form-control" id="affiliated_person" name="affiliated_person"
                                               required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-2">
                                        <label for="planed_time">计划持续时间（天）</label>
                                        <input type="text" class="form-control" id="planed_time" name="planed_time" required>
                                    </div>

                                    <div class="form-group col-2">
                                        <label for="planed_start_time">计划开始日期</label>
                                        <input type="text" class="form-control" id="planed_start_time" name="planed_start_time" required>
                                        <div id="planed_start_time-valid" class="valid-feedback">
                                            OK
                                        </div>
                                        <div id="planed_start_time-invalid" class="invalid-feedback">
                                            请输入一个可用的用户名
                                        </div>
                                    </div>

                                    <div class="form-group col-2">
                                        <label for="planed_end_time">计划完成日期</label>
                                        <input type="text" class="form-control" id="planed_end_time" name="planed_end_time" required>
                                        <div id="planed_end_time-valid" class="valid-feedback">
                                            OK
                                        </div>
                                        <div id="planed_end-invalid" class="invalid-feedback">
                                            请输入一个可用的用户名
                                        </div>
                                    </div>

                                    <div class="form-group col-2">
                                        <label for="actual_time">实际持续时间（天）</label>
                                        <input type="text" class="form-control" id="actual_time" name="actual_time">
                                    </div>

                                    <div class="form-group col-2">
                                        <label for="actual_start_time">实际开始日期</label>
                                        <input type="text" class="form-control" id="actual_start_time" name="actual_start_time"
                                        >
                                    </div>
                                    <div class="form-group col-2">
                                        <label for="actual_end_time">实际完成日期</label>
                                        <input type="text" class="form-control" id="actual_end_time" name="actual_end_time">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="form-group col-2">
                                        <label for="advanced_postponed_time">提前/推迟（天）</label>
                                        <input type="text" class="form-control" id="advanced_postponed_time"
                                               name="advanced_postponed_time" required>
                                    </div>

                                    <div class="form-group col-10">
                                        <label for="remark">备注（文档页数、程序量，修改意见等）</label>
                                        <input type="text" class="form-control" id="remark" name="remark" required>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-1">
                                        <button type="submit" class="btn btn-primary" id="submitForm" name="btn" value="submit">提交</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <div class="table-responsive">
            <table class="table mt-3 table-hover">
                <thead>
                <tr>
                    <th scope="col" nowrap>序号</th>
                    <th scope="col" nowrap>任务类型</th>
                    <th scope="col" nowrap>任务名称</th>
                    <th scope="col" nowrap>工作成果</th>
                    <th scope="col" nowrap>是否通过评审</th>
                    <th scope="col" nowrap>负责人</th>
                    <th scope="col" nowrap>参与人</th>
                    <th scope="col" nowrap>计划持续时间</th>
                    <th scope="col" nowrap>计划开始日期</th>
                    <th scope="col" nowrap>计划完成日期</th>
                    <th scope="col" nowrap>实际持续时间</th>
                    <th scope="col" nowrap>实际开始日期</th>
                    <th scope="col" nowrap>实际完成日期</th>
                    <th scope="col" nowrap>提前/推迟（天）</th>
                    <th scope="col" nowrap>备注（文档页数、程序量，修改意见等）</th>
                </tr>
                </thead>
                <tbody>

                {% for result in results %}
                    <tr title="{{ result.id }}">
                        <th scope="row">{{ forloop.counter }}</th>
                        <td nowrap>{{ result.type }}</td>
                        <td nowrap>{{ result.plan_name }}</td>
                        <td nowrap>{{ result.plan_result }}</td>
                        <td nowrap>{% if result.is_reviewed %}是{% else %}否{% endif %}</td>
                        <td nowrap>{{ result.head_person }}</td>
                        <td nowrap>{{ result.affiliated_person }}</td>
                        <td nowrap>{{ result.planed_time }}</td>
                        <td nowrap>{{ result.planed_start_time|date:"Y-m-d" }}</td>
                        <td nowrap>{{ result.planed_end_time|date:"Y-m-d" }}</td>
                        <td nowrap>
                            {% if result.actual_time is not None %}{{ result.actual_time }}{% else %}{% endif %}</td>
                        <td nowrap>{{ result.actual_start_time|date:"Y-m-d" }}</td>
                        <td nowrap>{{ result.actual_end_time|date:"Y-m-d" }}</td>
                        <td nowrap>{{ result.advanced_postponed_time }}</td>
                        <td>{{ result.remark }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}